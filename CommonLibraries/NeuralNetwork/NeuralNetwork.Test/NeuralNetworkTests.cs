using System.Numerics;
using TRW.CommonLibraries.NeuralNetwork;

namespace TRW.CommonLibraries.NeuralNetwork.Test
{
    [TestClass]
    public sealed class NeuralNetworkTests
    {
        [TestMethod]
        public void TestXorProbability ()
        {
            double[][] X = {
                [0,0], [0,1], [1, 0], [1, 1]
            };
            double[][] Y = {
                [1, 0], [0,1], [0,1], [1,0] // class0 for (0,0) and (1,1), class1 for (0,1),(1,0)
            };

            NeuralNetwork nn = new NeuralNetwork();
            nn.AddLayer(2, 8, ActivationFunction.LeakyReLU);
            nn.AddLayer(8, 8, ActivationFunction.LeakyReLU);
            nn.AddLayer(8, 8, ActivationFunction.LeakyReLU);
            nn.AddLayer(8, 2, ActivationFunction.Softmax);

            double finalLoss = nn.TrainBatch(X.ToList(), Y.ToList(), 0.1, 1e-4, 5000, true);
            Console.WriteLine($"Training done. Loss={finalLoss}\n");

            Assert.IsTrue(finalLoss > 0);
            Assert.AreEqual(0, (int)finalLoss, $"finalLoss [{finalLoss}]");

            for (int i = 0; i < X.Length; ++i)
            {
                double[] p = nn.Forward(X[i]);
                Console.WriteLine($"Input [{X[i][0]},{X[i][1]}] -> probs [{p[0]}, {p[1]}]");

                // 1,0 if 0,0 or 1,1
                if (X[i][0] == X[i][1])
                {
                    int prob = (int)Math.Round(p[0]);
                    Assert.AreEqual(1, prob, $"Expected ~1,0 for [{X[i][0]},{X[i][1]}], got [{p[0]}, {p[1]}]");
                }
                // 0,1 else
                else
                {
                    int prob = (int)Math.Round(p[1]);
                    Assert.AreEqual(1, prob, $"Expected ~0,1 for [{X[i][0]},{X[i][1]}], got [{p[0]}, {p[1]}]");

                }
            }

        }

        [TestMethod]
        public void TestTrainer()
        {
            Trainer trainer = new Trainer();
            trainer.AddLayer(2, ActivationFunction.Tanh);
            trainer.AddLayer(2, ActivationFunction.Linear);
            trainer.AddLayer(2, ActivationFunction.Linear);
            trainer.AddLayer(2, 1, ActivationFunction.Tanh);

            List<double[]> X = 
            [
                [2, 00501],
                [2, 01001],
                [2, 02801],
                [2, 02940],
                [2, 03031],
                [2, 03897],
                [2, 03901],
                [2, 04992],
                [2, 05544],
                [2, 06001],
                [2, 06928],
                [2, 07001],
                [2, 08989],
                [2, 14925],
                [2, 15001],
                [2, 19640],
                [2, 19701],
                [2, 19980],
                [2, 20601],
                [2, 21930],
                [2, 27006],
                [2, 28909],
                [2, 29001],
                [2, 29945],
                [2, 30002],
                [2, 32003],
                [2, 34997],
                [2, 35004],
                [2, 36925],
                [2, 37010],
                [2, 38589],
                [2, 38601],
                [2, 39776],
                [2, 39901],
                [2, 40003],
                [2, 42788],
                [2, 43001],
                [2, 45999],
                [2, 46001],
                [2, 47997],
                [2, 48001],
                [2, 49971],
                [2, 50001],
                [2, 52809],
                [2, 55001],
                [2, 56763],
                [2, 57001],
                [2, 57799],
                [2, 58001],
                [2, 58856],
                [2, 59001],
                [2, 59937],
                [2, 60001],
                [2, 62999],
                [2, 63001],
                [2, 65899],
                [2, 66002],
                [2, 67954],
                [2, 68001],
                [2, 69367],
                [2, 70001],
                [2, 71497],
                [2, 71601],
                [2, 72959],
                [2, 73001],
                [2, 73301],
                [2, 74966],
                [2, 80001],
                [2, 81658],
                [2, 83201],
                [2, 83888],
                [2, 85001],
                [2, 86556],
                [2, 87001],
                [2, 88441],
                [2, 88595],
                [2, 88901],
                [2, 89883],
                [2, 90001],
                [2, 96162],
                [2, 96701],
                [2, 96898],
                [2, 97001],
                [2, 97920],
                [2, 99501],
                [2, 99950],
                [3, 00501],
                [3, 01001],
                [3, 02801],
                [3, 02940],
                [3, 03031],
                [3, 03897],
                [3, 03901],
                [3, 04992],
                [3, 05544],
                [3, 06001],
                [3, 06928],
                [3, 07001],
                [3, 08989],
                [3, 14925],
                [3, 15001],
                [3, 19640],
                [3, 19701],
                [3, 19980],
                [3, 20601],
                [3, 21930],
                [3, 27006],
                [3, 28909],
                [3, 29001],
                [3, 29945],
                [3, 30002],
                [3, 32003],
                [3, 34997],
                [3, 35004],
                [3, 36925],
                [3, 37010],
                [3, 38589],
                [3, 38601],
                [3, 39776],
                [3, 39901],
                [3, 40003],
                [3, 42788],
                [3, 43001],
                [3, 45999],
                [3, 46001],
                [3, 47997],
                [3, 48001],
                [3, 49971],
                [3, 50001],
                [3, 52809],
                [3, 55001],
                [3, 56763],
                [3, 57001],
                [3, 57799],
                [3, 58001],
                [3, 58856],
                [3, 59001],
                [3, 59937],
                [3, 60001],
                [3, 62999],
                [3, 63001],
                [3, 65899],
                [3, 66002],
                [3, 67954],
                [3, 68001],
                [3, 69367],
                [3, 70001],
                [3, 71497],
                [3, 71601],
                [3, 72959],
                [3, 73001],
                [3, 73301],
                [3, 74966],
                [3, 80001],
                [3, 81658],
                [3, 83201],
                [3, 83888],
                [3, 85001],
                [3, 86556],
                [3, 87001],
                [3, 88441],
                [3, 88595],
                [3, 88901],
                [3, 89883],
                [3, 90001],
                [3, 96162],
                [3, 96701],
                [3, 96898],
                [3, 97001],
                [3, 97920],
                [3, 99501],
                [3, 99950],
                [4, 00501],
                [4, 01001],
                [4, 02801],
                [4, 02940],
                [4, 03031],
                [4, 03897],
                [4, 03901],
                [4, 04992],
                [4, 05544],
                [4, 06001],
                [4, 06928],
                [4, 07001],
                [4, 08989],
                [4, 14925],
                [4, 15001],
                [4, 19640],
                [4, 19701],
                [4, 19980],
                [4, 20601],
                [4, 21930],
                [4, 27006],
                [4, 28909],
                [4, 29001],
                [4, 29945],
                [4, 30002],
                [4, 32003],
                [4, 34997],
                [4, 35004],
                [4, 36925],
                [4, 37010],
                [4, 38589],
                [4, 38601],
                [4, 39776],
                [4, 39901],
                [4, 40003],
                [4, 42788],
                [4, 43001],
                [4, 45999],
                [4, 46001],
                [4, 47997],
                [4, 48001],
                [4, 49971],
                [4, 50001],
                [4, 52809],
                [4, 55001],
                [4, 56763],
                [4, 57001],
                [4, 57799],
                [4, 58001],
                [4, 58856],
                [4, 59001],
                [4, 59937],
                [4, 60001],
                [4, 62999],
                [4, 63001],
                [4, 65899],
                [4, 66002],
                [4, 67954],
                [4, 68001],
                [4, 69367],
                [4, 70001],
                [4, 71497],
                [4, 71601],
                [4, 72959],
                [4, 73001],
                [4, 73301],
                [4, 74966],
                [4, 80001],
                [4, 81658],
                [4, 83201],
                [4, 83888],
                [4, 85001],
                [4, 86556],
                [4, 87001],
                [4, 88441],
                [4, 88595],
                [4, 88901],
                [4, 89883],
                [4, 90001],
                [4, 96162],
                [4, 96701],
                [4, 96898],
                [4, 97001],
                [4, 97920],
                [4, 99501],
                [4, 99950],
                [5, 00501],
                [5, 01001],
                [5, 02801],
                [5, 02940],
                [5, 03031],
                [5, 03897],
                [5, 03901],
                [5, 04992],
                [5, 05544],
                [5, 06001],
                [5, 06928],
                [5, 07001],
                [5, 08989],
                [5, 14925],
                [5, 15001],
                [5, 19640],
                [5, 19701],
                [5, 19980],
                [5, 20601],
                [5, 21930],
                [5, 27006],
                [5, 28909],
                [5, 29001],
                [5, 29945],
                [5, 30002],
                [5, 32003],
                [5, 34997],
                [5, 35004],
                [5, 36925],
                [5, 37010],
                [5, 38589],
                [5, 38601],
                [5, 39776],
                [5, 39901],
                [5, 40003],
                [5, 42788],
                [5, 43001],
                [5, 45999],
                [5, 46001],
                [5, 47997],
                [5, 48001],
                [5, 49971],
                [5, 50001],
                [5, 52809],
                [5, 55001],
                [5, 56763],
                [5, 57001],
                [5, 57799],
                [5, 58001],
                [5, 58856],
                [5, 59001],
                [5, 59937],
                [5, 60001],
                [5, 62999],
                [5, 63001],
                [5, 65899],
                [5, 66002],
                [5, 67954],
                [5, 68001],
                [5, 69367],
                [5, 70001],
                [5, 71497],
                [5, 71601],
                [5, 72959],
                [5, 73001],
                [5, 73301],
                [5, 74966],
                [5, 80001],
                [5, 81658],
                [5, 83201],
                [5, 83888],
                [5, 85001],
                [5, 86556],
                [5, 87001],
                [5, 88441],
                [5, 88595],
                [5, 88901],
                [5, 89883],
                [5, 90001],
                [5, 96162],
                [5, 96701],
                [5, 96898],
                [5, 97001],
                [5, 97920],
                [5, 99501],
                [5, 99950],
                [6, 00501],
                [6, 01001],
                [6, 02801],
                [6, 02940],
                [6, 03031],
                [6, 03897],
                [6, 03901],
                [6, 04992],
                [6, 05544],
                [6, 06001],
                [6, 06928],
                [6, 07001],
                [6, 08989],
                [6, 14925],
                [6, 15001],
                [6, 19640],
                [6, 19701],
                [6, 19980],
                [6, 20601],
                [6, 21930],
                [6, 27006],
                [6, 28909],
                [6, 29001],
                [6, 29945],
                [6, 30002],
                [6, 32003],
                [6, 34997],
                [6, 35004],
                [6, 36925],
                [6, 37010],
                [6, 38589],
                [6, 38601],
                [6, 39776],
                [6, 39901],
                [6, 40003],
                [6, 42788],
                [6, 43001],
                [6, 45999],
                [6, 46001],
                [6, 47997],
                [6, 48001],
                [6, 49971],
                [6, 50001],
                [6, 52809],
                [6, 55001],
                [6, 56763],
                [6, 57001],
                [6, 57799],
                [6, 58001],
                [6, 58856],
                [6, 59001],
                [6, 59937],
                [6, 60001],
                [6, 62999],
                [6, 63001],
                [6, 65899],
                [6, 66002],
                [6, 67954],
                [6, 68001],
                [6, 69367],
                [6, 70001],
                [6, 71497],
                [6, 71601],
                [6, 72959],
                [6, 73001],
                [6, 73301],
                [6, 74966],
                [6, 80001],
                [6, 81658],
                [6, 83201],
                [6, 83888],
                [6, 85001],
                [6, 86556],
                [6, 87001],
                [6, 88441],
                [6, 88595],
                [6, 88901],
                [6, 89883],
                [6, 90001],
                [6, 96162],
                [6, 96701],
                [6, 96898],
                [6, 97001],
                [6, 97920],
                [6, 99501],
                [6, 99950],
                [7, 00501],
                [7, 01001],
                [7, 02801],
                [7, 02940],
                [7, 03031],
                [7, 03897],
                [7, 03901],
                [7, 04992],
                [7, 05544],
                [7, 06001],
                [7, 06928],
                [7, 07001],
                [7, 08989],
                [7, 14925],
                [7, 15001],
                [7, 19640],
                [7, 19701],
                [7, 19980],
                [7, 20601],
                [7, 21930],
                [7, 27006],
                [7, 28909],
                [7, 29001],
                [7, 29945],
                [7, 30002],
                [7, 32003],
                [7, 34997],
                [7, 35004],
                [7, 36925],
                [7, 37010],
                [7, 38589],
                [7, 38601],
                [7, 39776],
                [7, 39901],
                [7, 40003],
                [7, 42788],
                [7, 43001],
                [7, 45999],
                [7, 46001],
                [7, 47997],
                [7, 48001],
                [7, 49971],
                [7, 50001],
                [7, 52809],
                [7, 55001],
                [7, 56763],
                [7, 57001],
                [7, 57799],
                [7, 58001],
                [7, 58856],
                [7, 59001],
                [7, 59937],
                [7, 60001],
                [7, 62999],
                [7, 63001],
                [7, 65899],
                [7, 66002],
                [7, 67954],
                [7, 68001],
                [7, 69367],
                [7, 70001],
                [7, 71497],
                [7, 71601],
                [7, 72959],
                [7, 73001],
                [7, 73301],
                [7, 74966],
                [7, 80001],
                [7, 81658],
                [7, 83201],
                [7, 83888],
                [7, 85001],
                [7, 86556],
                [7, 87001],
                [7, 88441],
                [7, 88595],
                [7, 88901],
                [7, 89883],
                [7, 90001],
                [7, 96162],
                [7, 96701],
                [7, 96898],
                [7, 97001],
                [7, 97920],
                [7, 99501],
                [7, 99950],
                [1, 00501],
                [1, 01001],
                [1, 02801],
                [1, 02940],
                [1, 03031],
                [1, 03897],
                [1, 03901],
                [1, 04992],
                [1, 05544],
                [1, 06001],
                [1, 06928],
                [1, 07001],
                [1, 08989],
                [1, 14925],
                [1, 15001],
                [1, 19640],
                [1, 19701],
                [1, 19980],
                [1, 20601],
                [1, 21930],
                [1, 27006],
                [1, 28909],
                [1, 29001],
                [1, 29945],
                [1, 30002],
                [1, 32003],
                [1, 34997],
                [1, 35004],
                [1, 36925],
                [1, 37010],
                [1, 38589],
                [1, 38601],
                [1, 39776],
                [1, 39901],
                [1, 40003],
                [1, 42788],
                [1, 43001],
                [1, 45999],
                [1, 46001],
                [1, 47997],
                [1, 48001],
                [1, 49971],
                [1, 50001],
                [1, 52809],
                [1, 55001],
                [1, 56763],
                [1, 57001],
                [1, 57799],
                [1, 58001],
                [1, 58856],
                [1, 59001],
                [1, 59937],
                [1, 60001],
                [1, 62999],
                [1, 63001],
                [1, 65899],
                [1, 66002],
                [1, 67954],
                [1, 68001],
                [1, 69367],
                [1, 70001],
                [1, 71497],
                [1, 71601],
                [1, 72959],
                [1, 73001],
                [1, 73301],
                [1, 74966],
                [1, 80001],
                [1, 81658],
                [1, 83201],
                [1, 83888],
                [1, 85001],
                [1, 86556],
                [1, 87001],
                [1, 88441],
                [1, 88595],
                [1, 88901],
                [1, 89883],
                [1, 90001],
                [1, 96162],
                [1, 96701],
                [1, 96898],
                [1, 97001],
                [1, 97920],
                [1, 99501],
                [1, 99950]
            ];

            List<double[]> Y =
            [
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [8],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [5],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [2],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [3],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [4],
                [5],
                [5],
                [5],
                [5],
                [5]
            ];

            trainer.Train(X, Y, epochs: 5000, learningRate: 0.01);

            List<double[]> testInputs = new List<double[]>
            {
                new double[] {2,63121},
                new double[] {6,63121},
                new double[] {1,20012}
            };

            List<double> expected = [2, 4, 4];

            for(int i = 0; i < testInputs.Count; i++)
            {
                double[] output = trainer.Predict(testInputs[i]);
                Console.WriteLine($"Input: [{string.Join(", ", testInputs[i])}] => Predicted: {output[0]}, Expected: {expected[i]}");
            }
        }
    }
}
